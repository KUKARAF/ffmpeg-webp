name: Build & Release FFmpeg Patched

on:
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Clone FFmpeg
      run: |
        git clone https://git.ffmpeg.org/ffmpeg.git
        cd ffmpeg
        git checkout master   # or a tag like n7.0

    - name: Apply patch
      working-directory: ffmpeg
      run: |
        curl -L 'https://patchwork.ffmpeg.org/project/ffmpeg/patch/20250401102902.89332-1-aattyy@gmail.com/raw/' -o webpdec.diff
        git apply webpdec.diff

    - name: Build inside Docker
      working-directory: ffmpeg
      run: |
        docker run --rm -v $PWD:/src -w /src ubuntu:24.04 bash -ex <<'EOT'
          apt-get update
          apt-get install -y build-essential yasm pkg-config libwebp-dev libwebpdemux-dev
          ./configure --enable-libwebp --enable-libwebpdec --enable-gpl --enable-nonfree
          make -j$(nproc)
          make install DESTDIR=/src/dist
        EOT

    - name: Package binary
      run: |
        tar czf ffmpeg-patched.tar.gz -C ffmpeg/dist usr/local/bin/ffmpeg
        ls -lh ffmpeg-patched.tar.gz

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: patched-${{ github.run_number }}
        release_name: "FFmpeg patched build ${{ github.run_number }}"
        assets: ffmpeg-patched.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
